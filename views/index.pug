doctype html
html
  head
    title SafeAlert Location
   
    meta(name='viewport', content='width=device-width, initial-scale=1.0')
    link(rel='stylesheet', href='https://unpkg.com/leaflet@1.4.0/dist/leaflet.css', integrity='sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==', crossorigin='')
    script(src='https://unpkg.com/leaflet@1.4.0/dist/leaflet.js', integrity='sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==', crossorigin='')
    script(src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js")
  body
    #mapid(style='width: 600px; height: 400px;')
    script.
      //MAKE SURE TO REPLACE PUBNUB KEYS 
      //pubnub init stuff
      var pubnub = new PubNub({
        subscribeKey: "pub-c-29fb8b6a-3c2a-43be-8bc6-dcc74275a575",
        publishKey: "sub-c-6d6a767c-112a-11e9-abd1-2a488504b737"
      })
    
      //sets the view to the inital area
      var mymap = L.map('mapid').setView([#{lat}, #{lon}], 13);
      L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1Ijoic2FtYmFtYm8iLCJhIjoiY2pyYXZ3aHl3MHgxazQzcGRpOW5yNmNlMyJ9.ON7c8v4ru-77yH57Re7MMA', {
        maxZoom: 18,
        attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
        '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
        'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
        id: 'mapbox.streets'
      }).addTo(mymap);
      //creates a marker with the inital coordinates
      var marker = L.marker([#{lat}, #{lon}]).addTo(mymap);
      var popUpHTML = '<b><a href="http://www.google.com/maps/place/#{lat},#{lon}">Find this on<br>Google Maps!</a></b>';
      marker.bindPopup(popUpHTML).openPopup()
      
      
      pubnub.addListener({
        status: function(statusEvent) {
            if (statusEvent.category === "PNConnectedCategory") {
                console.log("connected")
            }
        },
        message: function(msg) {
          //This function receives the message from the uuid channel and updates the map with the current location
          //also changes the marker to the new coordinates and pans the map to the new area.
            console.log("RECEIVED MESSAGE",msg.message);
            var ll = new L.LatLng(msg.message.lat, msg.message.lon)
            marker.setLatLng(ll)
            var popUpHTML = '<b><a href="http://www.google.com/maps/place/' + msg.message.lat + ',' + msg.message.lon +'">Find this on<br>Google Maps!</a></b>';
            marker.bindPopup(popUpHTML).openPopup()
            mymap.panTo(ll)
            
        },
        presence: function(presenceEvent) {
            // handle presence
        }
      }) 
      //subscribes to the uuid that is passed in through the url
      pubnub.subscribe({
          channels: ["#{uuid}"] 
      });    
      
    a(href="https://github.com/SambaDialloB/SafeAlertSite") Check out this github to learn how to build this site! 
      
      
    
     
